<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ°—åœ§ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      background: #f0f8ff;
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    select, button {
      font-size: 1em;
      padding: 6px 12px;
      margin-top: 10px;
    }
    .info, .alerts, .forecast {
      margin-top: 20px;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
    .level-1 { background: #fff6e5; }
    .level-2 { background: #ffe5e5; }
    .level-3 { background: #ffd2d2; font-weight: bold; }
    .level-0 { background: #e5f9ff; }
  </style>
</head>
<body>
  <h1>ğŸŒ¤ æ°—åœ§ãƒã‚§ãƒƒã‚«ãƒ¼ï¼ˆã—ã‚“ã©ã•é€šçŸ¥ã¤ãï¼‰</h1>

  <label for="city">éƒ½å¸‚ã‚’é¸æŠ:</label>
  <select id="city">
    <option value="Sapporo">æœ­å¹Œ</option>
    <option value="Sendai">ä»™å°</option>
    <option value="Niigata">æ–°æ½Ÿ</option>
    <option value="Tokyo">æ±äº¬</option>
    <option value="Kanazawa">é‡‘æ²¢</option>
    <option value="Nagoya">åå¤å±‹</option>
    <option value="Osaka">å¤§é˜ª</option>
    <option value="Hiroshima">åºƒå³¶</option>
    <option value="Kochi">é«˜çŸ¥</option>
    <option value="Fukuoka">ç¦å²¡</option>
    <option value="Naha">é‚£è¦‡</option>
    <option value="Saitama">åŸ¼ç‰</option>
    <option value="Kanagawa">ç¥å¥ˆå·</option>
  </select>

  <div class="info" id="pressureInfo">â³ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>
  <div class="alerts" id="alertMessage"></div>
  <div class="forecast" id="futureForecast"></div>
<script>
const cities = {
  Sapporo: { lat: 43.0642, lon: 141.3469 },
  Sendai: { lat: 38.2688, lon: 140.8721 },
  Niigata: { lat: 37.9026, lon: 139.0236 },
  Tokyo: { lat: 35.6895, lon: 139.6917 },
  Kanazawa: { lat: 36.5613, lon: 136.6562 },
  Nagoya: { lat: 35.1815, lon: 136.9066 },
  Osaka: { lat: 34.6937, lon: 135.5023 },
  Hiroshima: { lat: 34.3853, lon: 132.4553 },
  Kochi: { lat: 33.5597, lon: 133.5311 },
  Fukuoka: { lat: 33.5904, lon: 130.4017 },
  Naha: { lat: 26.2124, lon: 127.6809 },
  Saitama: { lat: 35.8617, lon: 139.6455 },
  Kanagawa: { lat: 35.4478, lon: 139.6425 }
};

document.getElementById("city").addEventListener("change", () => {
  const city = document.getElementById("city").value;
  fetchPressure(city);
});

async function fetchPressure(city) {
  const { lat, lon } = cities[city];
  const today = new Date();
  const startDate = new Date(today);
  startDate.setDate(startDate.getDate() - 1);
  const endDate = new Date(today);
  endDate.setDate(endDate.getDate() + 7);

  const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${startDate.toISOString().split("T")[0]}&end_date=${endDate.toISOString().split("T")[0]}&hourly=pressure_msl&timezone=Asia%2FTokyo`;
  const res = await fetch(url);
  const data = await res.json();

  const pressure = data.hourly.pressure_msl;
  const time = data.hourly.time;

  const now = new Date();
  const currentIndex = time.findIndex(t => t === now.toISOString().slice(0, 13) + ":00");
  const currentPressure = pressure[currentIndex];
  const yesterdayPressure = pressure[currentIndex - 24];

  // ä»Šã¨ã®å·®ã§ãƒ¬ãƒ™ãƒ«åˆ¤å®š
  const diff = Math.abs(currentPressure - yesterdayPressure);
  let level = 0;
  if (diff >= 2 && diff < 5) level = 1;
  else if (diff >= 5 && diff < 8) level = 2;
  else if (diff >= 8) level = 3;

  const info = document.getElementById("pressureInfo");
  info.className = `info level-${level}`;
  const levelTexts = ["ğŸ•Š å®‰å®š", "ğŸ˜Ÿ ã—ã‚“ã©ã„ã‹ã‚‚", "ğŸ˜– ã—ã‚“ã©ã„", "ğŸ˜« è¶…ã—ã‚“ã©ã„"];
  info.innerHTML = `ç¾åœ¨ã®æ°—åœ§: ${currentPressure.toFixed(1)} hPa<br>æ˜¨æ—¥ã¨ã®å·®: ${diff.toFixed(1)} hPa â†’ ${levelTexts[level]}`;
  const alert = document.getElementById("alertMessage");
  const future = document.getElementById("futureForecast");

  // æ€¥æ¿€ãªåè»¢ï¼ˆVå­—ãƒ»é€†Vå­—ï¼‰æ¤œå‡º
  alert.innerHTML = "";
  for (let i = currentIndex; i < currentIndex + 24; i++) {
    if (i + 2 >= pressure.length) break;
    const first = pressure[i];
    const mid = pressure[i + 1];
    const last = pressure[i + 2];

    if ((first > mid && mid < last) || (first < mid && mid > last)) {
      const t1 = new Date(time[i]).toLocaleString("ja-JP", { hour: '2-digit', hour12: false });
      const t3 = new Date(time[i+2]).toLocaleString("ja-JP", { hour: '2-digit', hour12: false });
      alert.innerHTML = `âš¡ æ€¥å¤‰æ³¨æ„ï¼š${t1}æ™‚ã€œ${t3}æ™‚ã«æ°—åœ§ãŒå¤§ããåè»¢ã—ã¾ã™ï¼`;
      break;
    }
  }

  // æœªæ¥7æ—¥åˆ†ã®æ—¥ã”ã¨ã®æœ€å¤§ãƒ»æœ€å°å·®ã‚’è¨ˆç®—
  future.innerHTML = "<strong>æœªæ¥7æ—¥é–“ã®æ°—åœ§å¤‰å‹•:</strong><br>";
  const futurePressures = pressure.slice(currentIndex, currentIndex + 7*24);
  for (let d = 0; d < 7; d++) {
    const dayData = futurePressures.slice(d*24, (d+1)*24);
    if (dayData.length < 24) continue;
    const max = Math.max(...dayData);
    const min = Math.min(...dayData);
    const gap = max - min;
    const date = new Date(time[currentIndex + d*24]).toLocaleDateString("ja-JP", { month: "2-digit", day: "2-digit" });

    if (Math.abs(gap) >= 4) {
      future.innerHTML += `ğŸ“… ${date}: æ°—åœ§å·® ${gap.toFixed(1)} hPa â†’ æ³¨æ„ï¼<br>`;
    }
  }
}
</script>
</body>
</html>
