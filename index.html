<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>気圧と体調チェック</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f8ff;
      padding: 20px;
    }
    h1 {
      color: #336699;
    }
    .button-group {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #336699;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .box {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>気圧と体調チェック</h1>
  <div class="button-group" id="city-buttons"></div>
  <div class="box" id="pressure-box">都市を選んでください</div>
  <div class="box" id="alert-box"></div>
  <div class="box" id="forecast-box"></div>
  <div class="box" id="history-box"></div>

  <script>
    const cities = {
      "札幌": { lat: 43.0642, lon: 141.3469 },
      "仙台": { lat: 38.2688, lon: 140.8721 },
      "新潟": { lat: 37.9026, lon: 139.0236 },
      "東京": { lat: 35.6895, lon: 139.6917 },
      "埼玉": { lat: 35.8617, lon: 139.6455 },
      "神奈川": { lat: 35.4478, lon: 139.6425 },
      "金沢": { lat: 36.5613, lon: 136.6562 },
      "名古屋": { lat: 35.1815, lon: 136.9066 },
      "大阪": { lat: 34.6937, lon: 135.5023 },
      "広島": { lat: 34.3853, lon: 132.4553 },
      "高知": { lat: 33.5597, lon: 133.5311 },
      "福岡": { lat: 33.5902, lon: 130.4017 },
      "那覇": { lat: 26.2124, lon: 127.6809 }
    };

    const pressureBox = document.getElementById("pressure-box");
    const alertBox = document.getElementById("alert-box");
    const forecastBox = document.getElementById("forecast-box");
    const historyBox = document.getElementById("history-box");

    Object.keys(cities).forEach(city => {
      const btn = document.createElement("button");
      btn.innerText = city;
      btn.onclick = () => fetchPressure(city);
      document.getElementById("city-buttons").appendChild(btn);
    });

    async function fetchPressure(city) {
      const { lat, lon } = cities[city];
      const now = new Date();
      const nowISO = now.toISOString();
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const times = data.hourly.time;
        const pressures = data.hourly.pressure_msl;
        const nowIndex = times.findIndex(t => new Date(t) > now);

        const currentPressure = pressures[nowIndex];
        const pastPressure = pressures[nowIndex - 3];
        const diff = currentPressure - pastPressure;

        const nowTime = new Date(times[nowIndex]).toLocaleString("ja-JP");
        const alertMessage = Math.abs(diff) >= 3
          ? `⚠️ 気圧が ${diff.toFixed(1)} hPa 変化しています。体調に注意してください。`
          : "現在の気圧変化は安定しています。";

        pressureBox.innerHTML = `<strong>${city}</strong> の<br><strong>${nowTime}</strong> の気圧は<br><span style="font-size: 1.5em;">${currentPressure} hPa</span> です。`;
        alertBox.innerText = alertMessage;

        checkFuturePressure(city);
        compareWithYesterday(city);

      } catch (e) {
        pressureBox.innerText = "データ取得に失敗しました。";
        console.error(e);
      }
    }

    async function checkFuturePressure(city) {
      const { lat, lon } = cities[city];
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=pressure_msl_max,pressure_msl_min&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const maxes = data.daily.pressure_msl_max;
        const mins = data.daily.pressure_msl_min;
        const days = data.daily.time;

        forecastBox.innerHTML = "";

        for (let i = 0; i < days.length; i++) {
          const diff = maxes[i] - mins[i];
          if (Math.abs(diff) >= 4) {
            forecastBox.innerHTML += `🔮 ${days[i]} に ${diff.toFixed(1)} hPa の気圧差があります。<br>`;
          }
        }

        if (!forecastBox.innerHTML) {
          forecastBox.innerText = "🕊 今後1週間に大きな気圧変化の予報はありません。";
        }
      } catch (e) {
        forecastBox.innerText = "予報取得に失敗しました。";
        console.error(e);
      }
    }

    async function compareWithYesterday(city) {
      const { lat, lon } = cities[city];
      const now = new Date();
      const yesterday = new Date(now);
      yesterday.setDate(now.getDate() - 1);
      const start = yesterday.toISOString().split("T")[0];
      const end = now.toISOString().split("T")[0];

      const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&hourly=pressure_msl&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const times = data.hourly.time;
        const pressures = data.hourly.pressure_msl;

        const sameHour = now.getHours();
        const sameTimeIndex = times.findIndex(t => new Date(t).getHours() === sameHour);

        if (sameTimeIndex !== -1) {
          const yPressure = pressures[sameTimeIndex];
          const diff = pressureBox.innerText.includes("hPa") ? parseFloat(pressureBox.innerText.match(/([\d\.]+) hPa/)[1]) - yPressure : 0;
          historyBox.innerText = `昨日の同時刻と比べて ${diff.toFixed(1)} hPa ${diff >= 0 ? "上昇" : "低下"}しています。`;
        } else {
          historyBox.innerText = "昨日の同時刻の気圧データが見つかりませんでした。";
        }
      } catch (e) {
        historyBox.innerText = "昨日との比較に失敗しました。";
        console.error(e);
      }
    }
  </script>
</body>
</html>
