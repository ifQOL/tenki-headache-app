<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ°—åœ§ï¼†å¯’æš–å·®ãƒã‚§ãƒƒã‚«ãƒ¼</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <!-- Chart.jsè¿½åŠ  -->
  <style>
    body {
      margin: 0;
      font-family: 'Helvetica Neue', sans-serif;
      background: linear-gradient(to top, #a8e6cf 40%, #dcedc1 100%), url('https://images.unsplash.com/photo-1506744038136-46273834b3fb?fit=crop&w=1600&q=80') no-repeat center center fixed;
      background-size: cover;
      min-height: 100vh;
      color: #333;
      text-align: center;
    }
    h1 {
      margin-top: 30px;
      color: #2c6e91;
      text-shadow: 1px 1px 2px #fff;
    }
    select, button {
      margin: 10px;
      padding: 8px 16px;
      font-size: 1rem;
      border-radius: 8px;
    }
    .card {
      background: rgba(255,255,255,0.9);
      margin: 20px auto;
      padding: 20px;
      width: 90%;
      max-width: 600px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    .level-image {
      width: 80px;
      height: auto;
      margin: 10px 0;
    }
    canvas {
      margin-top: 20px;
    }
  </style>
</head>

<body>
  <h1>ğŸŒ¤ æ°—åœ§ï¼†å¯’æš–å·®ãƒã‚§ãƒƒã‚«ãƒ¼</h1>

  <div class="card">
    <label for="city">éƒ½å¸‚ã‚’é¸æŠ:</label>
    <select id="city">
      <option value="Sapporo">æœ­å¹Œ</option>
      <option value="Sendai">ä»™å°</option>
      <option value="Niigata">æ–°æ½Ÿ</option>
      <option value="Tokyo">æ±äº¬</option>
      <option value="Kanazawa">é‡‘æ²¢</option>
      <option value="Nagoya">åå¤å±‹</option>
      <option value="Osaka">å¤§é˜ª</option>
      <option value="Hiroshima">åºƒå³¶</option>
      <option value="Kochi">é«˜çŸ¥</option>
      <option value="Fukuoka">ç¦å²¡</option>
      <option value="Naha">é‚£è¦‡</option>
      <option value="Saitama">åŸ¼ç‰</option>
      <option value="Kanagawa">ç¥å¥ˆå·</option>
    </select>
  </div>

  <div class="card" id="pressureInfo">â³ ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>

  <div class="card" id="alertMessage"></div>

  <div class="card" id="futureForecast"></div>

  <div class="card">
    <canvas id="pressureChart" width="400" height="200"></canvas>
  </div>

<script>
// --- ãƒ‡ãƒ¼ã‚¿è¨­å®š ---
const cities = {
  Sapporo: { lat: 43.0642, lon: 141.3469 },
  Sendai: { lat: 38.2688, lon: 140.8721 },
  Niigata: { lat: 37.9026, lon: 139.0236 },
  Tokyo: { lat: 35.6895, lon: 139.6917 },
  Kanazawa: { lat: 36.5613, lon: 136.6562 },
  Nagoya: { lat: 35.1815, lon: 136.9066 },
  Osaka: { lat: 34.6937, lon: 135.5023 },
  Hiroshima: { lat: 34.3853, lon: 132.4553 },
  Kochi: { lat: 33.5597, lon: 133.5311 },
  Fukuoka: { lat: 33.5904, lon: 130.4017 },
  Naha: { lat: 26.2124, lon: 127.6809 },
  Saitama: { lat: 35.8617, lon: 139.6455 },
  Kanagawa: { lat: 35.4478, lon: 139.6425 }
};

let pressureChart;

document.getElementById("city").addEventListener("change", () => {
  const city = document.getElementById("city").value;
  fetchCurrentPressure(city);
});

async function fetchCurrentPressure(city) {
  const { lat, lon } = cities[city];
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl&daily=pressure_msl_max,pressure_msl_min,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;

  const res = await fetch(url);
  const data = await res.json();

  const pressures = data.hourly.pressure_msl;
  const times = data.hourly.time.map(t => new Date(t));
  
  const now = new Date();
  let closestIndex = -1;
  let minDiff = Infinity;
  for (let i = 0; i < times.length; i++) {
    const diffMs = Math.abs(now - times[i]);
    if (diffMs < minDiff) {
      minDiff = diffMs;
      closestIndex = i;
    }
  }

  if (closestIndex === -1 || pressures[closestIndex] == null) {
    document.getElementById("pressureInfo").innerHTML = "âš ï¸ ç¾åœ¨ã®æ°—åœ§ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚";
    return;
  }

  const currentPressure = pressures[closestIndex];

  const savedData = JSON.parse(localStorage.getItem("yesterdayPressure") || "null");
  let message = "";
  let levelImage = "";

  if (savedData && savedData.pressure && savedData.date) {
    const savedDate = new Date(savedData.date);
    const today = new Date();
    if (today.getDate() - savedDate.getDate() === 1 ||
        (savedDate.getDate() === new Date(today.getFullYear(), today.getMonth(), 0).getDate() && today.getDate() === 1)) {
      const diff = currentPressure - savedData.pressure;
      let level = 0;
      if (Math.abs(diff) >= 2 && Math.abs(diff) < 5) level = 1;
      else if (Math.abs(diff) >= 5 && Math.abs(diff) < 8) level = 2;
      else if (Math.abs(diff) >= 8) level = 3;

      const levelTexts = ["ğŸ•Š å®‰å®š", "ğŸ˜Ÿ è¦æ³¨æ„", "ğŸ˜– æ³¨æ„", "ğŸ˜« è¶…æ³¨æ„"];
      message = `æ˜¨æ—¥ã¨ã®å·®: ${diff.toFixed(1)} hPa â†’ ${levelTexts[level]}`;

      // ä»®ç”»åƒè¨­å®šï¼ˆã‚ã¨ã§å·®ã—æ›¿ãˆOKï¼‰
      if (level === 1) levelImage = `<img src="https://via.placeholder.com/80x80?text=è¦æ³¨æ„" class="level-image" />`;
      if (level === 2) levelImage = `<img src="https://via.placeholder.com/80x80?text=æ³¨æ„" class="level-image" />`;
      if (level === 3) levelImage = `<img src="https://via.placeholder.com/80x80?text=è¶…æ³¨æ„" class="level-image" />`;
    } else {
      message = "æ˜¨æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
    }
  } else {
    message = "æ˜¨æ—¥ã®ãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
  }

  document.getElementById("pressureInfo").innerHTML = `
    ç¾åœ¨ã®æ°—åœ§: ${currentPressure.toFixed(1)} hPa<br>
    ${message}<br>${levelImage}
  `;

  localStorage.setItem("yesterdayPressure", JSON.stringify({
    pressure: currentPressure,
    date: now.toISOString()
  }));

  fetchFutureForecast(city, pressures, times);
}

async function fetchFutureForecast(city, pressures, times) {
  const { lat, lon } = cities[city];
  const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl&daily=pressure_msl_max,pressure_msl_min,temperature_2m_max,temperature_2m_min&timezone=Asia%2FTokyo`;

  const res = await fetch(url);
  const data = await res.json();

  const futureBox = document.getElementById("futureForecast");
  const alertBox = document.getElementById("alertMessage");
  futureBox.innerHTML = "<strong>æœªæ¥7æ—¥é–“ã®æ°—åœ§ãƒ»å¯’æš–å·®:</strong><br>";
  alertBox.innerHTML = "";

  const pressuresDailyMax = data.daily.pressure_msl_max;
  const pressuresDailyMin = data.daily.pressure_msl_min;
  const tempMax = data.daily.temperature_2m_max;
  const tempMin = data.daily.temperature_2m_min;
  const days = data.daily.time;

  // ã‚°ãƒ©ãƒ•æç”»
  if (pressureChart) pressureChart.destroy();
  const ctx = document.getElementById('pressureChart').getContext('2d');
  pressureChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: days,
      datasets: [{
        label: 'æ°—åœ§å¤‰åŒ–',
        data: pressuresDailyMax,
        borderColor: 'blue',
        backgroundColor: 'lightblue',
        fill: true
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false
    }
  });

  // ã‚¢ãƒ©ãƒ¼ãƒˆ
  for (let d = 0; d < days.length; d++) {
    const gap = pressuresDailyMax[d] - pressuresDailyMin[d];
    const tempGap = tempMax[d] - tempMin[d];

    let warnings = "";

    if (Math.abs(gap) >= 4) {
      warnings += `ğŸŒ€ æ°—åœ§å·®${gap.toFixed(1)}hPa `;
    }
    if (tempGap >= 7 && tempGap < 10) {
      warnings += `ğŸŒ¡ï¸å¯’æš–å·®æ³¨æ„(${tempGap.toFixed(1)}â„ƒ) `;
    } else if (tempGap >= 10 && tempGap < 15) {
      warnings += `ğŸŒ¡ï¸ğŸŒ¡ï¸å¯’æš–å·®å¤§æ³¨æ„(${tempGap.toFixed(1)}â„ƒ) `;
    } else if (tempGap >= 15) {
      warnings += `ğŸŒ¡ï¸ğŸŒ¡ï¸ğŸŒ¡ï¸å¯’æš–å·®è¶…å¤§æ³¨æ„(${tempGap.toFixed(1)}â„ƒ) `;
    }

    if (warnings) {
      futureBox.innerHTML += `ğŸ“… ${days[d]}: ${warnings}<br>`;
    }
  }
}
</script>
</body>
</html>
