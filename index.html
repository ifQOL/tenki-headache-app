<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ°—åœ§ã¨ä½“èª¿ãƒã‚§ãƒƒã‚¯</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      background: #f0f8ff;
      padding: 20px;
    }
    h1 {
      color: #336699;
    }
    .button-group {
      margin: 20px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      background: #336699;
      color: white;
      border: none;
      border-radius: 5px;
    }
    .box {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <h1>æ°—åœ§ã¨ä½“èª¿ãƒã‚§ãƒƒã‚¯</h1>
  <div class="button-group" id="city-buttons"></div>
  <div class="box" id="pressure-box">éƒ½å¸‚ã‚’é¸ã‚“ã§ãã ã•ã„</div>
  <div class="box" id="alert-box"></div>
  <div class="box" id="forecast-box"></div>
  <div class="box" id="history-box"></div>

  <script>
    const cities = {
      "æœ­å¹Œ": { lat: 43.0642, lon: 141.3469 },
      "ä»™å°": { lat: 38.2688, lon: 140.8721 },
      "æ–°æ½Ÿ": { lat: 37.9026, lon: 139.0236 },
      "æ±äº¬": { lat: 35.6895, lon: 139.6917 },
      "åŸ¼ç‰": { lat: 35.8617, lon: 139.6455 },
      "ç¥å¥ˆå·": { lat: 35.4478, lon: 139.6425 },
      "é‡‘æ²¢": { lat: 36.5613, lon: 136.6562 },
      "åå¤å±‹": { lat: 35.1815, lon: 136.9066 },
      "å¤§é˜ª": { lat: 34.6937, lon: 135.5023 },
      "åºƒå³¶": { lat: 34.3853, lon: 132.4553 },
      "é«˜çŸ¥": { lat: 33.5597, lon: 133.5311 },
      "ç¦å²¡": { lat: 33.5902, lon: 130.4017 },
      "é‚£è¦‡": { lat: 26.2124, lon: 127.6809 }
    };

    const pressureBox = document.getElementById("pressure-box");
    const alertBox = document.getElementById("alert-box");
    const forecastBox = document.getElementById("forecast-box");
    const historyBox = document.getElementById("history-box");

    Object.keys(cities).forEach(city => {
      const btn = document.createElement("button");
      btn.innerText = city;
      btn.onclick = () => fetchPressure(city);
      document.getElementById("city-buttons").appendChild(btn);
    });

    async function fetchPressure(city) {
      const { lat, lon } = cities[city];
      const now = new Date();
      const nowISO = now.toISOString();
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=pressure_msl&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const times = data.hourly.time;
        const pressures = data.hourly.pressure_msl;
        const nowIndex = times.findIndex(t => new Date(t) > now);

        const currentPressure = pressures[nowIndex];
        const pastPressure = pressures[nowIndex - 3];
        const diff = currentPressure - pastPressure;

        const nowTime = new Date(times[nowIndex]).toLocaleString("ja-JP");
        const alertMessage = Math.abs(diff) >= 3
          ? `âš ï¸ æ°—åœ§ãŒ ${diff.toFixed(1)} hPa å¤‰åŒ–ã—ã¦ã„ã¾ã™ã€‚ä½“èª¿ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚`
          : "ç¾åœ¨ã®æ°—åœ§å¤‰åŒ–ã¯å®‰å®šã—ã¦ã„ã¾ã™ã€‚";

        pressureBox.innerHTML = `<strong>${city}</strong> ã®<br><strong>${nowTime}</strong> ã®æ°—åœ§ã¯<br><span style="font-size: 1.5em;">${currentPressure} hPa</span> ã§ã™ã€‚`;
        alertBox.innerText = alertMessage;

        checkFuturePressure(city);
        compareWithYesterday(city);

      } catch (e) {
        pressureBox.innerText = "ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        console.error(e);
      }
    }

    async function checkFuturePressure(city) {
      const { lat, lon } = cities[city];
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=pressure_msl_max,pressure_msl_min&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const maxes = data.daily.pressure_msl_max;
        const mins = data.daily.pressure_msl_min;
        const days = data.daily.time;

        forecastBox.innerHTML = "";

        for (let i = 0; i < days.length; i++) {
          const diff = maxes[i] - mins[i];
          if (Math.abs(diff) >= 4) {
            forecastBox.innerHTML += `ğŸ”® ${days[i]} ã« ${diff.toFixed(1)} hPa ã®æ°—åœ§å·®ãŒã‚ã‚Šã¾ã™ã€‚<br>`;
          }
        }

        if (!forecastBox.innerHTML) {
          forecastBox.innerText = "ğŸ•Š ä»Šå¾Œ1é€±é–“ã«å¤§ããªæ°—åœ§å¤‰åŒ–ã®äºˆå ±ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚";
        }
      } catch (e) {
        forecastBox.innerText = "äºˆå ±å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        console.error(e);
      }
    }

    async function compareWithYesterday(city) {
      const { lat, lon } = cities[city];
      const now = new Date();
      const yesterday = new Date(now);
      yesterday.setDate(now.getDate() - 1);
      const start = yesterday.toISOString().split("T")[0];
      const end = now.toISOString().split("T")[0];

      const url = `https://archive-api.open-meteo.com/v1/archive?latitude=${lat}&longitude=${lon}&start_date=${start}&end_date=${end}&hourly=pressure_msl&timezone=Asia%2FTokyo`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const times = data.hourly.time;
        const pressures = data.hourly.pressure_msl;

        const sameHour = now.getHours();
        const sameTimeIndex = times.findIndex(t => new Date(t).getHours() === sameHour);

        if (sameTimeIndex !== -1) {
          const yPressure = pressures[sameTimeIndex];
          const diff = pressureBox.innerText.includes("hPa") ? parseFloat(pressureBox.innerText.match(/([\d\.]+) hPa/)[1]) - yPressure : 0;
          historyBox.innerText = `æ˜¨æ—¥ã®åŒæ™‚åˆ»ã¨æ¯”ã¹ã¦ ${diff.toFixed(1)} hPa ${diff >= 0 ? "ä¸Šæ˜‡" : "ä½ä¸‹"}ã—ã¦ã„ã¾ã™ã€‚`;
        } else {
          historyBox.innerText = "æ˜¨æ—¥ã®åŒæ™‚åˆ»ã®æ°—åœ§ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚";
        }
      } catch (e) {
        historyBox.innerText = "æ˜¨æ—¥ã¨ã®æ¯”è¼ƒã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        console.error(e);
      }
    }
  </script>
</body>
</html>
